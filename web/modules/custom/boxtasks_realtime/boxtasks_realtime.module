<?php

/**
 * @file
 * Primary module hooks for BoxTasks Real-time module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_insert().
 */
function boxtasks_realtime_entity_insert(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      $publisher->publishCardEvent($entity, 'card.created');
      break;

    case 'board_list':
      $publisher->publishListEvent($entity, 'list.created');
      break;

    case 'card_comment':
      $publisher->publishCommentEvent($entity, 'comment.created');
      break;
  }
}

/**
 * Implements hook_entity_update().
 */
function boxtasks_realtime_entity_update(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      // Check if card was moved (list changed)
      $original = $entity->original ?? NULL;
      if ($original) {
        // Use target_id and load entities explicitly to ensure we get proper UUIDs
        // The ->entity lazy loading may not work reliably for original entities
        $nodeStorage = \Drupal::entityTypeManager()->getStorage('node');

        $oldListTargetId = $original->hasField('field_card_list') && !$original->get('field_card_list')->isEmpty()
          ? $original->get('field_card_list')->target_id
          : NULL;
        $newListTargetId = $entity->hasField('field_card_list') && !$entity->get('field_card_list')->isEmpty()
          ? $entity->get('field_card_list')->target_id
          : NULL;

        // Check if list changed by comparing target IDs
        if ($oldListTargetId && $newListTargetId && $oldListTargetId !== $newListTargetId) {
          // Load the list entities to get their UUIDs
          $oldList = $nodeStorage->load($oldListTargetId);
          $newList = $nodeStorage->load($newListTargetId);

          if ($oldList && $newList) {
            $oldListId = $oldList->uuid();
            $newListId = $newList->uuid();
            $position = $entity->hasField('field_card_position')
              ? (int) $entity->get('field_card_position')->value
              : 0;
            $publisher->publishCardMoved($entity, $oldListId, $newListId, $position);
            return;
          }
        }

        // Check if members changed
        if ($entity->hasField('field_card_members')) {
          $oldMemberIds = [];
          $newMemberIds = [];

          // Get old member IDs
          if ($original->hasField('field_card_members')) {
            foreach ($original->get('field_card_members') as $memberRef) {
              if ($memberRef->target_id) {
                $oldMemberIds[] = (int) $memberRef->target_id;
              }
            }
          }

          // Get new member IDs
          foreach ($entity->get('field_card_members') as $memberRef) {
            if ($memberRef->target_id) {
              $newMemberIds[] = (int) $memberRef->target_id;
            }
          }

          // Find added members
          $addedMembers = array_diff($newMemberIds, $oldMemberIds);
          foreach ($addedMembers as $userId) {
            $publisher->publishMemberAssigned($entity, $userId);
          }

          // Find removed members
          $removedMembers = array_diff($oldMemberIds, $newMemberIds);
          foreach ($removedMembers as $userId) {
            $publisher->publishMemberUnassigned($entity, $userId);
          }

          // If members changed, don't publish general update (member events are sufficient)
          if (!empty($addedMembers) || !empty($removedMembers)) {
            return;
          }
        }
      }
      $publisher->publishCardEvent($entity, 'card.updated');
      break;

    case 'board_list':
      $publisher->publishListEvent($entity, 'list.updated');
      break;

    case 'card_comment':
      $publisher->publishCommentEvent($entity, 'comment.updated');
      break;
  }
}

/**
 * Implements hook_entity_predelete().
 */
function boxtasks_realtime_entity_predelete(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      // Get board ID before deletion
      $boardId = NULL;
      if ($entity->hasField('field_card_list') && !$entity->get('field_card_list')->isEmpty()) {
        $list = $entity->get('field_card_list')->entity;
        if ($list && $list->hasField('field_list_board') && !$list->get('field_list_board')->isEmpty()) {
          $boardId = $list->get('field_list_board')->entity?->uuid();
        }
      }
      if ($boardId) {
        $publisher->publishCardDeleted($entity->uuid(), $boardId);
      }
      break;

    case 'board_list':
      // Get board ID before deletion
      $boardId = NULL;
      if ($entity->hasField('field_list_board') && !$entity->get('field_list_board')->isEmpty()) {
        $boardId = $entity->get('field_list_board')->entity?->uuid();
      }
      if ($boardId) {
        $publisher->publishListDeleted($entity->uuid(), $boardId);
      }
      break;

    case 'card_comment':
      $publisher->publishCommentEvent($entity, 'comment.deleted');
      break;
  }
}
