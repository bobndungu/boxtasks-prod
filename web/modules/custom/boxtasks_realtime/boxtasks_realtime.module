<?php

/**
 * @file
 * Primary module hooks for BoxTasks Real-time module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_insert().
 */
function boxtasks_realtime_entity_insert(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      $publisher->publishCardEvent($entity, 'card.created');
      break;

    case 'board_list':
      $publisher->publishListEvent($entity, 'list.created');
      break;

    case 'card_comment':
      $publisher->publishCommentEvent($entity, 'comment.created');
      break;

    case 'member_role':
      // A new member was added to a workspace
      _boxtasks_realtime_publish_member_role_created($entity, $publisher);
      break;
  }
}

/**
 * Implements hook_entity_update().
 */
function boxtasks_realtime_entity_update(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      // Check if card was moved (list changed)
      $original = $entity->original ?? NULL;
      if ($original) {
        // Use target_id and load entities explicitly to ensure we get proper UUIDs
        // The ->entity lazy loading may not work reliably for original entities
        $nodeStorage = \Drupal::entityTypeManager()->getStorage('node');

        $oldListTargetId = $original->hasField('field_card_list') && !$original->get('field_card_list')->isEmpty()
          ? $original->get('field_card_list')->target_id
          : NULL;
        $newListTargetId = $entity->hasField('field_card_list') && !$entity->get('field_card_list')->isEmpty()
          ? $entity->get('field_card_list')->target_id
          : NULL;

        // Check if list changed by comparing target IDs
        if ($oldListTargetId && $newListTargetId && $oldListTargetId !== $newListTargetId) {
          // Load the list entities to get their UUIDs
          $oldList = $nodeStorage->load($oldListTargetId);
          $newList = $nodeStorage->load($newListTargetId);

          if ($oldList && $newList) {
            $oldListId = $oldList->uuid();
            $newListId = $newList->uuid();
            $position = $entity->hasField('field_card_position')
              ? (int) $entity->get('field_card_position')->value
              : 0;
            $publisher->publishCardMoved($entity, $oldListId, $newListId, $position);
            return;
          }
        }

        // Check if members changed
        if ($entity->hasField('field_card_members')) {
          $oldMemberIds = [];
          $newMemberIds = [];

          // Get old member IDs
          if ($original->hasField('field_card_members')) {
            foreach ($original->get('field_card_members') as $memberRef) {
              if ($memberRef->target_id) {
                $oldMemberIds[] = (int) $memberRef->target_id;
              }
            }
          }

          // Get new member IDs
          foreach ($entity->get('field_card_members') as $memberRef) {
            if ($memberRef->target_id) {
              $newMemberIds[] = (int) $memberRef->target_id;
            }
          }

          // Find added members
          $addedMembers = array_diff($newMemberIds, $oldMemberIds);
          foreach ($addedMembers as $userId) {
            $publisher->publishMemberAssigned($entity, $userId);
          }

          // Find removed members
          $removedMembers = array_diff($oldMemberIds, $newMemberIds);
          foreach ($removedMembers as $userId) {
            $publisher->publishMemberUnassigned($entity, $userId);
          }

          // If members changed, don't publish general update (member events are sufficient)
          if (!empty($addedMembers) || !empty($removedMembers)) {
            return;
          }
        }
      }
      $publisher->publishCardEvent($entity, 'card.updated');
      break;

    case 'board_list':
      $publisher->publishListEvent($entity, 'list.updated');
      break;

    case 'card_comment':
      $publisher->publishCommentEvent($entity, 'comment.updated');
      break;

    case 'member_role':
      // Member's role was updated
      _boxtasks_realtime_publish_member_role_updated($entity, $publisher);
      break;
  }
}

/**
 * Implements hook_entity_predelete().
 */
function boxtasks_realtime_entity_predelete(EntityInterface $entity) {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  $publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');

  switch ($entity->bundle()) {
    case 'card':
      // Get board ID before deletion
      $boardId = NULL;
      if ($entity->hasField('field_card_list') && !$entity->get('field_card_list')->isEmpty()) {
        $list = $entity->get('field_card_list')->entity;
        if ($list && $list->hasField('field_list_board') && !$list->get('field_list_board')->isEmpty()) {
          $boardId = $list->get('field_list_board')->entity?->uuid();
        }
      }
      if ($boardId) {
        $publisher->publishCardDeleted($entity->uuid(), $boardId);
      }
      break;

    case 'board_list':
      // Get board ID before deletion
      $boardId = NULL;
      if ($entity->hasField('field_list_board') && !$entity->get('field_list_board')->isEmpty()) {
        $boardId = $entity->get('field_list_board')->entity?->uuid();
      }
      if ($boardId) {
        $publisher->publishListDeleted($entity->uuid(), $boardId);
      }
      break;

    case 'card_comment':
      // Get IDs before deletion clears them
      $commentId = $entity->uuid();
      $cardId = NULL;
      $boardId = NULL;
      if ($entity->hasField('field_comment_card') && !$entity->get('field_comment_card')->isEmpty()) {
        $card = $entity->get('field_comment_card')->entity;
        if ($card) {
          $cardId = $card->uuid();
          // Get board ID from card
          if ($card->hasField('field_card_list') && !$card->get('field_card_list')->isEmpty()) {
            $list = $card->get('field_card_list')->entity;
            if ($list && $list->hasField('field_list_board') && !$list->get('field_list_board')->isEmpty()) {
              $boardId = $list->get('field_list_board')->entity?->uuid();
            }
          }
        }
      }
      if ($boardId && $commentId) {
        $publisher->publishCommentDeleted($commentId, $cardId, $boardId);
      }
      break;

    case 'member_role':
      // Member was removed from a workspace
      _boxtasks_realtime_publish_member_role_deleted($entity, $publisher);
      break;
  }
}

/**
 * Publishes a member role created event.
 *
 * @param \Drupal\node\NodeInterface $memberRole
 *   The member_role entity.
 * @param \Drupal\boxtasks_realtime\Service\MercurePublisher $publisher
 *   The Mercure publisher service.
 */
function _boxtasks_realtime_publish_member_role_created(NodeInterface $memberRole, $publisher): void {
  // Get workspace ID
  $workspaceId = NULL;
  if ($memberRole->hasField('field_member_role_workspace') && !$memberRole->get('field_member_role_workspace')->isEmpty()) {
    $workspace = $memberRole->get('field_member_role_workspace')->entity;
    if ($workspace) {
      $workspaceId = $workspace->uuid();
    }
  }

  // Get user ID
  $userId = NULL;
  if ($memberRole->hasField('field_member_role_user') && !$memberRole->get('field_member_role_user')->isEmpty()) {
    $userId = $memberRole->get('field_member_role_user')->target_id;
  }

  // Get role info
  $roleId = NULL;
  $roleName = NULL;
  if ($memberRole->hasField('field_member_role_role') && !$memberRole->get('field_member_role_role')->isEmpty()) {
    $role = $memberRole->get('field_member_role_role')->entity;
    if ($role) {
      $roleId = $role->uuid();
      $roleName = $role->label();
    }
  }

  if ($workspaceId && $userId) {
    $publisher->publishWorkspaceMemberAdded($workspaceId, $userId, $roleId, $roleName);
  }
}

/**
 * Publishes a member role updated event.
 *
 * @param \Drupal\node\NodeInterface $memberRole
 *   The member_role entity.
 * @param \Drupal\boxtasks_realtime\Service\MercurePublisher $publisher
 *   The Mercure publisher service.
 */
function _boxtasks_realtime_publish_member_role_updated(NodeInterface $memberRole, $publisher): void {
  // Get workspace ID
  $workspaceId = NULL;
  if ($memberRole->hasField('field_member_role_workspace') && !$memberRole->get('field_member_role_workspace')->isEmpty()) {
    $workspace = $memberRole->get('field_member_role_workspace')->entity;
    if ($workspace) {
      $workspaceId = $workspace->uuid();
    }
  }

  // Get user ID
  $userId = NULL;
  if ($memberRole->hasField('field_member_role_user') && !$memberRole->get('field_member_role_user')->isEmpty()) {
    $userId = $memberRole->get('field_member_role_user')->target_id;
  }

  // Get role info
  $roleId = NULL;
  $roleName = NULL;
  if ($memberRole->hasField('field_member_role_role') && !$memberRole->get('field_member_role_role')->isEmpty()) {
    $role = $memberRole->get('field_member_role_role')->entity;
    if ($role) {
      $roleId = $role->uuid();
      $roleName = $role->label();
    }
  }

  if ($workspaceId && $userId && $roleId) {
    $publisher->publishWorkspaceMemberRoleChanged($workspaceId, $userId, $roleId, $roleName);
  }
}

/**
 * Publishes a member role deleted event.
 *
 * @param \Drupal\node\NodeInterface $memberRole
 *   The member_role entity.
 * @param \Drupal\boxtasks_realtime\Service\MercurePublisher $publisher
 *   The Mercure publisher service.
 */
function _boxtasks_realtime_publish_member_role_deleted(NodeInterface $memberRole, $publisher): void {
  // Get workspace ID before deletion
  $workspaceId = NULL;
  if ($memberRole->hasField('field_member_role_workspace') && !$memberRole->get('field_member_role_workspace')->isEmpty()) {
    $workspace = $memberRole->get('field_member_role_workspace')->entity;
    if ($workspace) {
      $workspaceId = $workspace->uuid();
    }
  }

  // Get user ID before deletion
  $userId = NULL;
  if ($memberRole->hasField('field_member_role_user') && !$memberRole->get('field_member_role_user')->isEmpty()) {
    $userId = $memberRole->get('field_member_role_user')->target_id;
  }

  if ($workspaceId && $userId) {
    $publisher->publishWorkspaceMemberRemoved($workspaceId, $userId);
  }
}
