<?php

/**
 * @file
 * BoxTasks Activity module.
 *
 * Provides activity logging for BoxTasks entities.
 */

use Drupal\boxtasks_activity\ActivityLogger;
use Drupal\node\NodeInterface;
use Drupal\user\UserInterface;

/**
 * Gets the full display name for a user.
 *
 * @param \Drupal\user\UserInterface|int|null $user
 *   The user entity or user ID. If NULL, uses current user.
 *
 * @return string
 *   The user's full display name from field_display_name, or fallback.
 */
function _boxtasks_activity_get_user_full_name(UserInterface|int|null $user = NULL): string {
  if ($user === NULL) {
    $user = \Drupal::entityTypeManager()->getStorage('user')->load(\Drupal::currentUser()->id());
  }
  elseif (is_int($user)) {
    $user = \Drupal::entityTypeManager()->getStorage('user')->load($user);
  }

  if ($user instanceof UserInterface) {
    if ($user->hasField('field_display_name') && !$user->get('field_display_name')->isEmpty()) {
      return $user->get('field_display_name')->value;
    }
    return $user->getDisplayName();
  }

  return 'Unknown User';
}

/**
 * Implements hook_ENTITY_TYPE_insert() for node entities.
 *
 * Logs activity when cards and lists are created.
 * Also publishes Mercure events when activity nodes are created.
 */
function boxtasks_activity_node_insert(NodeInterface $node): void {
  // Publish Mercure event when an activity is created.
  if ($node->bundle() === 'activity') {
    try {
      $mercure_publisher = \Drupal::service('boxtasks_realtime.mercure_publisher');
      $mercure_publisher->publishActivityEvent($node);
    }
    catch (\Exception $e) {
      // Log error but don't prevent activity creation.
      \Drupal::logger('boxtasks_activity')->error('Failed to publish activity to Mercure: @message', [
        '@message' => $e->getMessage(),
      ]);
    }
    return;
  }

  $logger = \Drupal::service('boxtasks_activity.logger');

  switch ($node->bundle()) {
    case 'card':
      $logger->logCardActivity(ActivityLogger::TYPE_CARD_CREATED, $node);
      break;

    case 'board_list':
      $board_id = $node->get('field_list_board')->target_id;
      $logger->log(
        ActivityLogger::TYPE_LIST_CREATED,
        _boxtasks_activity_get_user_full_name() . ' created list "' . $node->getTitle() . '"',
        $board_id
      );
      break;

    case 'card_comment':
      $card_id = $node->get('field_comment_card')->target_id;
      if ($card_id) {
        $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
        if ($card) {
          // Get comment text (truncated for activity display).
          $comment_text = '';
          if ($node->hasField('field_comment_text') && !$node->get('field_comment_text')->isEmpty()) {
            $comment_text = $node->get('field_comment_text')->value;
            // Truncate to 200 chars for display.
            if (strlen($comment_text) > 200) {
              $comment_text = substr($comment_text, 0, 197) . '...';
            }
          }
          $logger->logCardActivity(
            ActivityLogger::TYPE_COMMENT_ADDED,
            $card,
            NULL,
            [
              'comment_id' => $node->id(),
              'comment_text' => $comment_text,
            ]
          );
        }
      }
      break;

    case 'card_custom_field_value':
      // Log custom field value creation.
      $card_id = $node->get('field_cfv_card')->target_id ?? NULL;
      $field_def_id = $node->get('field_cfv_definition')->target_id ?? NULL;
      if ($card_id && $field_def_id) {
        $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
        $field_def = \Drupal::entityTypeManager()->getStorage('node')->load($field_def_id);
        if ($card && $field_def) {
          $field_name = $field_def->getTitle();
          $new_value = $node->hasField('field_cfv_value') ? $node->get('field_cfv_value')->value : '';
          $logger->logCardActivity(
            ActivityLogger::TYPE_CUSTOM_FIELD_UPDATED,
            $card,
            NULL,
            [
              'field_name' => $field_name,
              'new_value' => $new_value,
            ]
          );
        }
      }
      break;

    case 'checklist':
      $card_id = $node->get('field_checklist_card')->target_id;
      if ($card_id) {
        $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
        if ($card) {
          $logger->logCardActivity(
            ActivityLogger::TYPE_CHECKLIST_ADDED,
            $card,
            NULL,
            ['checklist_name' => $node->getTitle()]
          );
        }
      }
      break;
  }
}

/**
 * Implements hook_ENTITY_TYPE_predelete() for node entities.
 *
 * Logs activity when comments are deleted (before they are removed).
 */
function boxtasks_activity_node_predelete(NodeInterface $node): void {
  // Only process comments.
  if ($node->bundle() !== 'card_comment') {
    return;
  }

  $logger = \Drupal::service('boxtasks_activity.logger');

  $card_id = $node->get('field_comment_card')->target_id;
  if ($card_id) {
    $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
    if ($card) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_COMMENT_DELETED,
        $card,
        NULL,
        ['comment_id' => $node->id()]
      );
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_update() for node entities.
 *
 * Logs activity when cards, comments, and custom fields are updated.
 */
function boxtasks_activity_node_update(NodeInterface $node): void {
  $logger = \Drupal::service('boxtasks_activity.logger');

  // Handle comment updates.
  if ($node->bundle() === 'card_comment') {
    $original = $node->original;
    $current_text = $node->hasField('field_comment_text') ? ($node->get('field_comment_text')->value ?? '') : '';
    $original_text = $original->hasField('field_comment_text') ? ($original->get('field_comment_text')->value ?? '') : '';

    // Only log if text actually changed.
    if ($current_text !== $original_text) {
      $card_id = $node->get('field_comment_card')->target_id;
      if ($card_id) {
        $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
        if ($card) {
          // Truncate text for display.
          $display_text = $current_text;
          if (strlen($display_text) > 200) {
            $display_text = substr($display_text, 0, 197) . '...';
          }
          $logger->logCardActivity(
            ActivityLogger::TYPE_COMMENT_UPDATED,
            $card,
            NULL,
            [
              'comment_id' => $node->id(),
              'comment_text' => $display_text,
              'old_value' => strlen($original_text) > 200 ? substr($original_text, 0, 197) . '...' : $original_text,
              'new_value' => $display_text,
            ]
          );
        }
      }
    }
    return;
  }

  // Handle custom field value updates.
  if ($node->bundle() === 'card_custom_field_value') {
    $original = $node->original;
    $current_value = $node->hasField('field_cfv_value') ? ($node->get('field_cfv_value')->value ?? '') : '';
    $original_value = $original->hasField('field_cfv_value') ? ($original->get('field_cfv_value')->value ?? '') : '';

    // Only log if value actually changed.
    if ($current_value !== $original_value) {
      $card_id = $node->get('field_cfv_card')->target_id ?? NULL;
      $field_def_id = $node->get('field_cfv_definition')->target_id ?? NULL;
      if ($card_id && $field_def_id) {
        $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
        $field_def = \Drupal::entityTypeManager()->getStorage('node')->load($field_def_id);
        if ($card && $field_def) {
          $field_name = $field_def->getTitle();
          $logger->logCardActivity(
            ActivityLogger::TYPE_CUSTOM_FIELD_UPDATED,
            $card,
            NULL,
            [
              'field_name' => $field_name,
              'old_value' => $original_value,
              'new_value' => $current_value,
            ]
          );
        }
      }
    }
    return;
  }

  // Only process cards from here on.
  if ($node->bundle() !== 'card') {
    return;
  }
  $original = $node->original;

  // Check for card moved (list changed).
  $current_list = $node->get('field_card_list')->target_id;
  $original_list = $original->get('field_card_list')->target_id;
  if ($current_list !== $original_list) {
    // Get list names.
    $from_list = _boxtasks_activity_get_list_name($original_list);
    $to_list = _boxtasks_activity_get_list_name($current_list);

    $logger->logCardActivity(
      ActivityLogger::TYPE_CARD_MOVED,
      $node,
      NULL,
      ['from_list' => $from_list, 'to_list' => $to_list]
    );
  }

  // Check for card completed.
  $current_completed = (bool) $node->get('field_card_completed')->value;
  $original_completed = (bool) $original->get('field_card_completed')->value;
  if ($current_completed && !$original_completed) {
    $logger->logCardActivity(ActivityLogger::TYPE_CARD_COMPLETED, $node);
  }

  // Check for card archived.
  $current_archived = (bool) $node->get('field_card_archived')->value;
  $original_archived = (bool) $original->get('field_card_archived')->value;
  if ($current_archived && !$original_archived) {
    $logger->logCardActivity(ActivityLogger::TYPE_CARD_ARCHIVED, $node);
  }
  elseif (!$current_archived && $original_archived) {
    $logger->logCardActivity(ActivityLogger::TYPE_CARD_RESTORED, $node);
  }

  // Check for label added/removed.
  $current_labels = _boxtasks_activity_get_labels($node);
  $original_labels = _boxtasks_activity_get_labels($original);

  $added_labels = array_diff($current_labels, $original_labels);
  $removed_labels = array_diff($original_labels, $current_labels);

  foreach ($added_labels as $label) {
    $logger->logCardActivity(
      ActivityLogger::TYPE_LABEL_ADDED,
      $node,
      NULL,
      ['label' => $label]
    );
  }

  foreach ($removed_labels as $label) {
    $logger->logCardActivity(
      ActivityLogger::TYPE_LABEL_REMOVED,
      $node,
      NULL,
      ['label' => $label]
    );
  }

  // Check for member added/removed.
  $current_members = _boxtasks_activity_get_members($node);
  $original_members = _boxtasks_activity_get_members($original);

  $added_members = array_diff($current_members, $original_members);
  $removed_members = array_diff($original_members, $current_members);

  foreach ($added_members as $member_id) {
    $logger->logCardActivity(
      ActivityLogger::TYPE_MEMBER_ADDED,
      $node,
      NULL,
      ['member_name' => _boxtasks_activity_get_user_full_name((int) $member_id)]
    );
  }

  foreach ($removed_members as $member_id) {
    $logger->logCardActivity(
      ActivityLogger::TYPE_MEMBER_REMOVED,
      $node,
      NULL,
      ['member_name' => _boxtasks_activity_get_user_full_name((int) $member_id)]
    );
  }

  // Check for due date change.
  $current_due = $node->get('field_card_due_date')->value;
  $original_due = $original->get('field_card_due_date')->value;

  if ($current_due !== $original_due) {
    if ($current_due && !$original_due) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_DUE_DATE_SET,
        $node,
        NULL,
        ['due_date' => $current_due, 'new_value' => $current_due]
      );
    }
    elseif (!$current_due && $original_due) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_DUE_DATE_REMOVED,
        $node,
        NULL,
        ['old_value' => $original_due]
      );
    }
    else {
      $logger->logCardActivity(
        ActivityLogger::TYPE_DUE_DATE_UPDATED,
        $node,
        NULL,
        ['old_value' => $original_due, 'new_value' => $current_due]
      );
    }
  }

  // Check for start date change.
  if ($node->hasField('field_card_start_date') && $original->hasField('field_card_start_date')) {
    $current_start = $node->get('field_card_start_date')->value;
    $original_start = $original->get('field_card_start_date')->value;

    if ($current_start !== $original_start) {
      if ($current_start && !$original_start) {
        $logger->logCardActivity(
          ActivityLogger::TYPE_START_DATE_SET,
          $node,
          NULL,
          ['start_date' => $current_start, 'new_value' => $current_start]
        );
      }
      elseif (!$current_start && $original_start) {
        $logger->logCardActivity(
          ActivityLogger::TYPE_START_DATE_REMOVED,
          $node,
          NULL,
          ['old_value' => $original_start]
        );
      }
      else {
        $logger->logCardActivity(
          ActivityLogger::TYPE_START_DATE_UPDATED,
          $node,
          NULL,
          ['old_value' => $original_start, 'new_value' => $current_start]
        );
      }
    }
  }

  // Check for title change.
  $current_title = $node->getTitle();
  $original_title = $original->getTitle();
  if ($current_title !== $original_title) {
    $logger->logCardActivity(
      ActivityLogger::TYPE_TITLE_UPDATED,
      $node,
      NULL,
      ['old_value' => $original_title, 'new_value' => $current_title]
    );
  }

  // Check for description change.
  if ($node->hasField('field_card_description') && $original->hasField('field_card_description')) {
    $current_desc = $node->get('field_card_description')->value ?? '';
    $original_desc = $original->get('field_card_description')->value ?? '';
    if ($current_desc !== $original_desc) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_DESCRIPTION_UPDATED,
        $node,
        NULL,
        ['old_value' => $original_desc, 'new_value' => $current_desc]
      );
    }
  }

  // Check for department change.
  if ($node->hasField('field_card_department')) {
    $current_dept_id = $node->get('field_card_department')->target_id;
    $original_dept_id = $original->get('field_card_department')->target_id;

    if ($current_dept_id !== $original_dept_id) {
      $current_dept_name = $current_dept_id ? _boxtasks_activity_get_taxonomy_term_name($current_dept_id) : '';
      $old_dept_name = $original_dept_id ? _boxtasks_activity_get_taxonomy_term_name($original_dept_id) : '';

      if ($current_dept_id && !$original_dept_id) {
        // Department was set.
        $logger->logCardActivity(
          ActivityLogger::TYPE_DEPARTMENT_SET,
          $node,
          NULL,
          ['department_name' => $current_dept_name]
        );
      }
      elseif (!$current_dept_id && $original_dept_id) {
        // Department was removed.
        $logger->logCardActivity(
          ActivityLogger::TYPE_DEPARTMENT_REMOVED,
          $node,
          NULL,
          ['old_department_name' => $old_dept_name, 'department_name' => $old_dept_name]
        );
      }
      else {
        // Department was changed.
        $logger->logCardActivity(
          ActivityLogger::TYPE_DEPARTMENT_CHANGED,
          $node,
          NULL,
          ['old_department_name' => $old_dept_name, 'department_name' => $current_dept_name]
        );
      }
    }
  }

  // Check for client change.
  if ($node->hasField('field_card_client')) {
    $current_client_id = $node->get('field_card_client')->target_id;
    $original_client_id = $original->get('field_card_client')->target_id;

    if ($current_client_id !== $original_client_id) {
      $current_client_name = $current_client_id ? _boxtasks_activity_get_taxonomy_term_name($current_client_id) : '';
      $old_client_name = $original_client_id ? _boxtasks_activity_get_taxonomy_term_name($original_client_id) : '';

      if ($current_client_id && !$original_client_id) {
        // Client was set.
        $logger->logCardActivity(
          ActivityLogger::TYPE_CLIENT_SET,
          $node,
          NULL,
          ['client_name' => $current_client_name]
        );
      }
      elseif (!$current_client_id && $original_client_id) {
        // Client was removed.
        $logger->logCardActivity(
          ActivityLogger::TYPE_CLIENT_REMOVED,
          $node,
          NULL,
          ['old_client_name' => $old_client_name, 'client_name' => $old_client_name]
        );
      }
      else {
        // Client was changed.
        $logger->logCardActivity(
          ActivityLogger::TYPE_CLIENT_CHANGED,
          $node,
          NULL,
          ['old_client_name' => $old_client_name, 'client_name' => $current_client_name]
        );
      }
    }
  }

  // Check for watcher added/removed.
  if ($node->hasField('field_card_watchers')) {
    $current_watchers = _boxtasks_activity_get_watchers($node);
    $original_watchers = _boxtasks_activity_get_watchers($original);

    $added_watchers = array_diff($current_watchers, $original_watchers);
    $removed_watchers = array_diff($original_watchers, $current_watchers);

    foreach ($added_watchers as $watcher_id) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_WATCHER_ADDED,
        $node,
        NULL,
        ['watcher_name' => _boxtasks_activity_get_user_full_name((int) $watcher_id)]
      );
    }

    foreach ($removed_watchers as $watcher_id) {
      $logger->logCardActivity(
        ActivityLogger::TYPE_WATCHER_REMOVED,
        $node,
        NULL,
        ['watcher_name' => _boxtasks_activity_get_user_full_name((int) $watcher_id)]
      );
    }
  }
}

/**
 * Gets a list name by ID.
 *
 * @param int|null $list_id
 *   The list ID.
 *
 * @return string
 *   The list name or 'Unknown'.
 */
function _boxtasks_activity_get_list_name(?int $list_id): string {
  if (!$list_id) {
    return 'Unknown';
  }

  $list = \Drupal::entityTypeManager()->getStorage('node')->load($list_id);
  return $list ? $list->getTitle() : 'Unknown';
}

/**
 * Gets labels from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of label values.
 */
function _boxtasks_activity_get_labels(NodeInterface $card): array {
  $labels = [];
  if ($card->hasField('field_card_labels')) {
    foreach ($card->get('field_card_labels') as $item) {
      $labels[] = $item->value;
    }
  }
  return $labels;
}

/**
 * Gets member IDs from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of member user IDs.
 */
function _boxtasks_activity_get_members(NodeInterface $card): array {
  $members = [];
  if ($card->hasField('field_card_members')) {
    foreach ($card->get('field_card_members') as $item) {
      $members[] = $item->target_id;
    }
  }
  return $members;
}

/**
 * Gets a taxonomy term name by ID.
 *
 * @param int|null $term_id
 *   The taxonomy term ID.
 *
 * @return string
 *   The term name or 'Unknown'.
 */
function _boxtasks_activity_get_taxonomy_term_name(?int $term_id): string {
  if (!$term_id) {
    return 'Unknown';
  }

  $term = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->load($term_id);
  return $term ? $term->getName() : 'Unknown';
}

/**
 * Gets watcher IDs from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of watcher user IDs.
 */
function _boxtasks_activity_get_watchers(NodeInterface $card): array {
  $watchers = [];
  if ($card->hasField('field_card_watchers')) {
    foreach ($card->get('field_card_watchers') as $item) {
      $watchers[] = $item->target_id;
    }
  }
  return $watchers;
}
