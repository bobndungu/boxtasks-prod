<?php

/**
 * @file
 * BoxTasks Role module for workspace-based role permissions.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_node_access().
 */
function boxtasks_role_node_access(NodeInterface $node, $op, AccountInterface $account) {
  // Only handle board and workspace nodes.
  $type = $node->bundle();
  if (!in_array($type, ['board', 'workspace'])) {
    return AccessResult::neutral();
  }

  // Super admins (Box Admin) bypass all checks.
  // Check both permission and role to ensure administrators always have access.
  if ($account->hasPermission('administer nodes') || boxtasks_role_is_super_admin($account)) {
    return AccessResult::allowed()->cachePerPermissions()->cachePerUser();
  }

  // Get the permission checker service.
  /** @var \Drupal\boxtasks_role\Service\PermissionChecker $permission_checker */
  $permission_checker = \Drupal::service('boxtasks_role.permission_checker');

  // Map operation to permission field.
  $permission_map = [
    'board' => [
      'view' => 'field_perm_board_view',
      'update' => 'field_perm_board_edit',
      'delete' => 'field_perm_board_delete',
    ],
    'workspace' => [
      'view' => 'field_perm_workspace_view',
      'update' => 'field_perm_workspace_edit',
      'delete' => 'field_perm_workspace_delete',
    ],
  ];

  if (!isset($permission_map[$type][$op])) {
    return AccessResult::neutral();
  }

  $permission_field = $permission_map[$type][$op];

  // Get workspace ID.
  if ($type === 'board') {
    if (!$node->hasField('field_board_workspace')) {
      return AccessResult::neutral();
    }
    $workspace_ref = $node->get('field_board_workspace')->entity;
    if (!$workspace_ref) {
      return AccessResult::neutral();
    }
    $workspace_id = $workspace_ref->uuid();
  }
  else {
    $workspace_id = $node->uuid();
  }

  // Check permission.
  $owner_id = (int) $node->getOwnerId();
  $has_permission = $permission_checker->checkPermission(
    $permission_field,
    $workspace_id,
    $owner_id,
    $account->id()
  );

  if ($has_permission) {
    return AccessResult::allowed()
      ->cachePerUser()
      ->addCacheableDependency($node);
  }

  return AccessResult::forbidden()
    ->cachePerUser()
    ->addCacheableDependency($node);
}

/**
 * Check if a user is a super admin (Box Admin).
 *
 * Super admins can see all workspaces, boards, and content
 * without needing to be added as members.
 *
 * @param \Drupal\Core\Session\AccountInterface $account
 *   The user account to check.
 *
 * @return bool
 *   TRUE if the user is a super admin.
 */
function boxtasks_role_is_super_admin(AccountInterface $account): bool {
  // Check for administrator role.
  $roles = $account->getRoles();

  // Users with 'administrator' role are super admins.
  if (in_array('administrator', $roles)) {
    return TRUE;
  }

  // Also check for any role containing 'admin' in case of custom admin roles.
  // But exclude 'workspace_admin' as that's a different permission level.
  foreach ($roles as $role) {
    if ($role === 'administrator' || $role === 'box_admin') {
      return TRUE;
    }
  }

  return FALSE;
}
