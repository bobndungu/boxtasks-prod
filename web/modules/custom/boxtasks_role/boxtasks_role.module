<?php

/**
 * @file
 * BoxTasks Role module for workspace-based role permissions.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_node_access().
 */
function boxtasks_role_node_access(NodeInterface $node, $op, AccountInterface $account) {
  // Only handle board and workspace nodes.
  $type = $node->bundle();
  if (!in_array($type, ['board', 'workspace'])) {
    return AccessResult::neutral();
  }

  // Super admins (Box Admin) bypass all checks.
  // Check both permission and role to ensure administrators always have access.
  if ($account->hasPermission('administer nodes') || boxtasks_role_is_super_admin($account)) {
    return AccessResult::allowed()->cachePerPermissions()->cachePerUser();
  }

  // Get the permission checker service.
  /** @var \Drupal\boxtasks_role\Service\PermissionChecker $permission_checker */
  $permission_checker = \Drupal::service('boxtasks_role.permission_checker');

  // Map operation to permission field.
  $permission_map = [
    'board' => [
      'view' => 'field_perm_board_view',
      'update' => 'field_perm_board_edit',
      'delete' => 'field_perm_board_delete',
    ],
    'workspace' => [
      'view' => 'field_perm_workspace_view',
      'update' => 'field_perm_workspace_edit',
      'delete' => 'field_perm_workspace_delete',
    ],
  ];

  if (!isset($permission_map[$type][$op])) {
    return AccessResult::neutral();
  }

  $permission_field = $permission_map[$type][$op];

  // For board view operations, use the specialized canViewBoard method
  // which handles board membership in addition to role permissions.
  if ($type === 'board' && $op === 'view') {
    $has_permission = $permission_checker->canViewBoard($node, (int) $account->id());

    // Debug logging - remove after testing.
    $trace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 10);
    $callers = array_map(function($t) {
      return ($t['class'] ?? '') . ($t['type'] ?? '') . ($t['function'] ?? '');
    }, $trace);
    \Drupal::logger('boxtasks_role')->debug('Board access check: board=%board (nid=%nid), user=%user (uid=%uid), result=%result, callers=%callers', [
      '%board' => $node->label(),
      '%nid' => $node->id(),
      '%user' => $account->getAccountName(),
      '%uid' => $account->id(),
      '%result' => $has_permission ? 'ALLOWED' : 'FORBIDDEN',
      '%callers' => implode(' -> ', array_slice($callers, 0, 5)),
    ]);

    if ($has_permission) {
      return AccessResult::allowed()
        ->cachePerUser()
        ->addCacheableDependency($node)
        ->addCacheTags(['node_list:member_role']);
    }

    return AccessResult::forbidden()
      ->cachePerUser()
      ->addCacheableDependency($node)
      ->addCacheTags(['node_list:member_role']);
  }

  // Get workspace ID for other operations.
  if ($type === 'board') {
    if (!$node->hasField('field_board_workspace')) {
      return AccessResult::neutral();
    }
    $workspace_ref = $node->get('field_board_workspace')->entity;
    if (!$workspace_ref) {
      return AccessResult::neutral();
    }
    $workspace_id = $workspace_ref->uuid();
  }
  else {
    $workspace_id = $node->uuid();
  }

  // Check permission.
  $owner_id = (int) $node->getOwnerId();
  $has_permission = $permission_checker->checkPermission(
    $permission_field,
    $workspace_id,
    $owner_id,
    $account->id()
  );

  if ($has_permission) {
    return AccessResult::allowed()
      ->cachePerUser()
      ->addCacheableDependency($node);
  }

  return AccessResult::forbidden()
    ->cachePerUser()
    ->addCacheableDependency($node);
}

/**
 * Check if a user is a super admin (Box Admin).
 *
 * Super admin is specifically uid = 1 only.
 * Having administrator role does NOT make someone a super admin.
 *
 * @param \Drupal\Core\Session\AccountInterface $account
 *   The user account to check.
 *
 * @return bool
 *   TRUE if the user is a super admin (uid = 1).
 */
function boxtasks_role_is_super_admin(AccountInterface $account): bool {
  // Super admin is ONLY uid = 1
  return (int) $account->id() === 1;
}
