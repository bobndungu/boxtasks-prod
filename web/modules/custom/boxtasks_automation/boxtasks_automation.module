<?php

/**
 * @file
 * BoxTasks Automation module.
 *
 * Provides automation rules for BoxTasks boards.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_mail().
 *
 * Prepares automation notification emails.
 */
function boxtasks_automation_mail($key, &$message, $params): void {
  switch ($key) {
    case 'automation_notification':
      $message['subject'] = $params['subject'] ?? 'BoxTasks Automation Notification';
      $message['body'][] = $params['message'] ?? 'An automation was triggered.';

      // Add card link if card_id is provided.
      if (!empty($params['card_id'])) {
        $message['body'][] = '';
        $message['body'][] = 'View the card: ' . \Drupal::request()->getSchemeAndHttpHost() . '/board/' . $params['card_id'];
      }
      break;
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert() for node entities.
 *
 * Fires the 'card_created' trigger when a new card is created.
 */
function boxtasks_automation_node_insert(NodeInterface $node): void {
  if ($node->bundle() !== 'card') {
    return;
  }

  _boxtasks_automation_fire_card_trigger($node, 'card_created');
}

/**
 * Implements hook_ENTITY_TYPE_update() for node entities.
 *
 * Fires various triggers when a card or checklist item is updated.
 */
function boxtasks_automation_node_update(NodeInterface $node): void {
  // Handle checklist item updates.
  if ($node->bundle() === 'checklist_item') {
    _boxtasks_automation_handle_checklist_item_update($node);
    return;
  }

  // Only process cards from here.
  if ($node->bundle() !== 'card') {
    return;
  }

  $original = $node->original;

  // Check for card moved (list changed).
  $current_list = $node->get('field_card_list')->target_id;
  $original_list = $original->get('field_card_list')->target_id;
  if ($current_list !== $original_list) {
    _boxtasks_automation_fire_card_trigger($node, 'card_moved', [
      'from_list_id' => $original_list,
      'to_list_id' => $current_list,
    ]);
  }

  // Check for card completed.
  $current_completed = (bool) $node->get('field_card_completed')->value;
  $original_completed = (bool) $original->get('field_card_completed')->value;
  if ($current_completed && !$original_completed) {
    _boxtasks_automation_fire_card_trigger($node, 'card_completed');
  }

  // Check for label added/removed.
  $current_labels = _boxtasks_automation_get_labels($node);
  $original_labels = _boxtasks_automation_get_labels($original);

  $added_labels = array_diff($current_labels, $original_labels);
  $removed_labels = array_diff($original_labels, $current_labels);

  foreach ($added_labels as $label) {
    _boxtasks_automation_fire_card_trigger($node, 'label_added', ['label' => $label]);
  }

  foreach ($removed_labels as $label) {
    _boxtasks_automation_fire_card_trigger($node, 'label_removed', ['label' => $label]);
  }

  // Check for member added.
  $current_members = _boxtasks_automation_get_members($node);
  $original_members = _boxtasks_automation_get_members($original);

  $added_members = array_diff($current_members, $original_members);

  foreach ($added_members as $member_id) {
    _boxtasks_automation_fire_card_trigger($node, 'member_added', ['user_id' => $member_id]);
  }

  // Check for watcher added/removed.
  $current_watchers = _boxtasks_automation_get_watchers($node);
  $original_watchers = _boxtasks_automation_get_watchers($original);

  $added_watchers = array_diff($current_watchers, $original_watchers);
  $removed_watchers = array_diff($original_watchers, $current_watchers);

  foreach ($added_watchers as $watcher_id) {
    _boxtasks_automation_fire_card_trigger($node, 'watcher_added', ['user_id' => $watcher_id]);
  }

  foreach ($removed_watchers as $watcher_id) {
    _boxtasks_automation_fire_card_trigger($node, 'watcher_removed', ['user_id' => $watcher_id]);
  }

  // Check for department change.
  $current_department = $node->hasField('field_card_department') ? $node->get('field_card_department')->target_id : NULL;
  $original_department = $original->hasField('field_card_department') ? $original->get('field_card_department')->target_id : NULL;
  if ($current_department !== $original_department) {
    _boxtasks_automation_fire_card_trigger($node, 'department_changed', [
      'from_department' => $original_department,
      'to_department' => $current_department,
    ]);
  }

  // Check for client change.
  $current_client = $node->hasField('field_card_client') ? $node->get('field_card_client')->target_id : NULL;
  $original_client = $original->hasField('field_card_client') ? $original->get('field_card_client')->target_id : NULL;
  if ($current_client !== $original_client) {
    _boxtasks_automation_fire_card_trigger($node, 'client_changed', [
      'from_client' => $original_client,
      'to_client' => $current_client,
    ]);
  }

  // Check for due date approaching (this would typically be handled by cron).
  // Here we fire it if due date was just set within the next 24 hours.
  $current_due = $node->get('field_card_due_date')->value;
  $original_due = $original->get('field_card_due_date')->value;

  if ($current_due && $current_due !== $original_due) {
    $due_timestamp = strtotime($current_due);
    $now = time();
    $one_day = 86400;

    // Fire if due date is within 24 hours.
    if ($due_timestamp > $now && $due_timestamp <= ($now + $one_day)) {
      _boxtasks_automation_fire_card_trigger($node, 'due_date_approaching', [
        'due_date' => $current_due,
      ]);
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert() for node entities.
 *
 * Fires 'comment_added' trigger when a comment is added to a card.
 */
function boxtasks_automation_node_insert_comment(NodeInterface $node): void {
  if ($node->bundle() !== 'card_comment') {
    return;
  }

  // Get the card this comment is for.
  $card_id = $node->hasField('field_comment_card') ? $node->get('field_comment_card')->target_id : NULL;
  if (!$card_id) {
    return;
  }

  $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
  if (!$card || $card->bundle() !== 'card') {
    return;
  }

  _boxtasks_automation_fire_card_trigger($card, 'comment_added', [
    'comment_id' => $node->id(),
    'comment_text' => $node->hasField('field_comment_text') ? $node->get('field_comment_text')->value : '',
    'comment_author' => $node->getOwnerId(),
  ]);
}

/**
 * Implements hook_ENTITY_TYPE_insert() for custom_field_value entities.
 *
 * Fires 'custom_field_changed' trigger when a custom field value is set.
 */
function boxtasks_automation_custom_field_value_insert(EntityInterface $entity): void {
  _boxtasks_automation_handle_custom_field_change($entity, NULL);
}

/**
 * Implements hook_ENTITY_TYPE_update() for custom_field_value entities.
 *
 * Fires 'custom_field_changed' trigger when a custom field value changes.
 */
function boxtasks_automation_custom_field_value_update(EntityInterface $entity): void {
  $original = $entity->original ?? NULL;
  _boxtasks_automation_handle_custom_field_change($entity, $original);
}

/**
 * Handles custom field value changes.
 */
function _boxtasks_automation_handle_custom_field_change(EntityInterface $entity, ?EntityInterface $original): void {
  // Get the card ID.
  $card_id = $entity->get('card_id')->target_id ?? NULL;
  if (!$card_id) {
    return;
  }

  $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
  if (!$card || $card->bundle() !== 'card') {
    return;
  }

  // Get field definition ID and values.
  $definition_id = $entity->get('definition_id')->target_id ?? NULL;
  $new_value = $entity->get('value')->value ?? '';
  $old_value = $original ? ($original->get('value')->value ?? '') : '';

  // Only fire trigger if value actually changed (or is new).
  if ($original === NULL || $new_value !== $old_value) {
    _boxtasks_automation_fire_card_trigger($card, 'custom_field_changed', [
      'field_id' => $definition_id,
      'old_value' => $old_value,
      'new_value' => $new_value,
    ]);
  }
}

/**
 * Handles checklist_item updates to check for checklist completion.
 *
 * Fires 'checklist_completed' trigger when all items in a checklist are complete.
 *
 * @param \Drupal\node\NodeInterface $node
 *   The checklist item node.
 */
function _boxtasks_automation_handle_checklist_item_update(NodeInterface $node): void {

  // Check if item was just completed.
  $original = $node->original;
  $current_completed = (bool) $node->get('field_item_completed')->value;
  $original_completed = (bool) $original->get('field_item_completed')->value;

  if (!$current_completed || $original_completed) {
    // Item wasn't just completed.
    return;
  }

  // Get the parent checklist.
  $checklist_id = $node->get('field_item_checklist')->target_id;
  if (!$checklist_id) {
    return;
  }

  $checklist = \Drupal::entityTypeManager()->getStorage('node')->load($checklist_id);
  if (!$checklist || $checklist->bundle() !== 'checklist') {
    return;
  }

  // Check if all items in the checklist are now complete.
  $query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'checklist_item')
    ->condition('field_item_checklist', $checklist_id)
    ->condition('field_item_completed', FALSE)
    ->accessCheck(FALSE);

  $incomplete_count = $query->count()->execute();

  if ($incomplete_count > 0) {
    // Still has incomplete items.
    return;
  }

  // All items are complete - get the card and fire trigger.
  $card_id = $checklist->get('field_checklist_card')->target_id;
  if (!$card_id) {
    return;
  }

  $card = \Drupal::entityTypeManager()->getStorage('node')->load($card_id);
  if (!$card || $card->bundle() !== 'card') {
    return;
  }

  _boxtasks_automation_fire_card_trigger($card, 'checklist_completed', [
    'checklist_id' => $checklist_id,
    'checklist_title' => $checklist->getTitle(),
  ]);
}

/**
 * Implements hook_cron().
 *
 * Checks for cards with approaching due dates and runs scheduled automations.
 */
function boxtasks_automation_cron(): void {
  _boxtasks_automation_check_due_dates();
  _boxtasks_automation_run_scheduled();
}

/**
 * Runs scheduled automations that are due.
 */
function _boxtasks_automation_run_scheduled(): void {
  $now = time();

  // Find all enabled scheduled rules that are due to run.
  $query = \Drupal::entityTypeManager()->getStorage('automation_rule')->getQuery()
    ->condition('trigger_type', 'scheduled')
    ->condition('enabled', TRUE)
    ->condition('next_scheduled_run', $now, '<=')
    ->accessCheck(FALSE);

  $rule_ids = $query->execute();

  if (empty($rule_ids)) {
    return;
  }

  $rules = \Drupal::entityTypeManager()->getStorage('automation_rule')->loadMultiple($rule_ids);
  $executor = \Drupal::service('boxtasks_automation.executor');

  foreach ($rules as $rule) {
    $board_id = $rule->get('board_id')->target_id;

    // Build trigger data for scheduled run.
    $trigger_data = [
      'scheduled_run' => TRUE,
      'run_time' => $now,
      'board_id' => $board_id,
    ];

    // Get scope from trigger config (all cards, or specific filter).
    $config = $rule->getTriggerConfig();
    $scope = $config['scope'] ?? 'all_cards';

    // Execute based on scope.
    if ($scope === 'all_cards') {
      // Run actions on all cards in the board.
      _boxtasks_automation_run_scheduled_on_board($rule, $executor, $board_id, $trigger_data, $config);
    }
    elseif ($scope === 'filtered_cards') {
      // Run actions on cards matching filter criteria.
      _boxtasks_automation_run_scheduled_on_filtered_cards($rule, $executor, $board_id, $trigger_data, $config);
    }
    else {
      // Single execution (no card context).
      $executor->executeRule($rule, 'scheduled', $trigger_data);
    }

    // Calculate and set the next scheduled run.
    $rule->calculateNextScheduledRun();
    $rule->save();

    \Drupal::logger('boxtasks_automation')->info('Executed scheduled automation "@name" on board @board.', [
      '@name' => $rule->get('name')->value,
      '@board' => $board_id,
    ]);
  }
}

/**
 * Runs scheduled automation on all cards in a board.
 */
function _boxtasks_automation_run_scheduled_on_board($rule, $executor, $board_id, $trigger_data, $config): void {
  // Get all lists in the board.
  $list_query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'board_list')
    ->condition('field_list_board', $board_id)
    ->accessCheck(FALSE);

  $list_ids = $list_query->execute();

  if (empty($list_ids)) {
    return;
  }

  // Get all cards in those lists.
  $card_query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'card')
    ->condition('field_card_list', $list_ids, 'IN')
    ->condition('field_card_archived', FALSE)
    ->accessCheck(FALSE);

  $card_ids = $card_query->execute();

  if (empty($card_ids)) {
    return;
  }

  $cards = \Drupal::entityTypeManager()->getStorage('node')->loadMultiple($card_ids);

  foreach ($cards as $card) {
    $card_trigger_data = $trigger_data + [
      'card_id' => $card->id(),
      'card' => [
        'id' => $card->id(),
        'uuid' => $card->uuid(),
        'title' => $card->getTitle(),
        'list_id' => $card->get('field_card_list')->target_id,
        'labels' => _boxtasks_automation_get_labels($card),
        'due_date' => $card->get('field_card_due_date')->value,
        'completed' => (bool) $card->get('field_card_completed')->value,
      ],
    ];

    // Check conditions before executing.
    $executor->executeRule($rule, 'scheduled', $card_trigger_data);
  }
}

/**
 * Runs scheduled automation on filtered cards.
 */
function _boxtasks_automation_run_scheduled_on_filtered_cards($rule, $executor, $board_id, $trigger_data, $config): void {
  // Build query based on filter config.
  $filter = $config['filter'] ?? [];

  // Get all lists in the board first.
  $list_query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'board_list')
    ->condition('field_list_board', $board_id)
    ->accessCheck(FALSE);

  $list_ids = $list_query->execute();

  if (empty($list_ids)) {
    return;
  }

  $card_query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'card')
    ->condition('field_card_list', $list_ids, 'IN')
    ->condition('field_card_archived', FALSE)
    ->accessCheck(FALSE);

  // Apply filters.
  if (!empty($filter['has_due_date'])) {
    $card_query->exists('field_card_due_date');
  }

  if (!empty($filter['is_overdue'])) {
    $card_query->condition('field_card_due_date', date('Y-m-d\TH:i:s'), '<');
  }

  if (!empty($filter['is_incomplete'])) {
    $card_query->condition('field_card_completed', FALSE);
  }

  if (!empty($filter['has_label'])) {
    $card_query->condition('field_card_labels', $filter['has_label']);
  }

  if (!empty($filter['in_list'])) {
    $card_query->condition('field_card_list', $filter['in_list']);
  }

  $card_ids = $card_query->execute();

  if (empty($card_ids)) {
    return;
  }

  $cards = \Drupal::entityTypeManager()->getStorage('node')->loadMultiple($card_ids);

  foreach ($cards as $card) {
    $card_trigger_data = $trigger_data + [
      'card_id' => $card->id(),
      'card' => [
        'id' => $card->id(),
        'uuid' => $card->uuid(),
        'title' => $card->getTitle(),
        'list_id' => $card->get('field_card_list')->target_id,
        'labels' => _boxtasks_automation_get_labels($card),
        'due_date' => $card->get('field_card_due_date')->value,
        'completed' => (bool) $card->get('field_card_completed')->value,
      ],
    ];

    $executor->executeRule($rule, 'scheduled', $card_trigger_data);
  }
}

/**
 * Helper function to fire a card automation trigger.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 * @param string $trigger_type
 *   The trigger type.
 * @param array $extra_data
 *   Additional data to include in the trigger.
 */
function _boxtasks_automation_fire_card_trigger(NodeInterface $card, string $trigger_type, array $extra_data = []): void {
  // Get the board ID from the card's list.
  $list_id = $card->get('field_card_list')->target_id;
  if (!$list_id) {
    return;
  }

  $list = \Drupal::entityTypeManager()->getStorage('node')->load($list_id);
  if (!$list || $list->bundle() !== 'board_list') {
    return;
  }

  $board_id = $list->get('field_list_board')->target_id;
  if (!$board_id) {
    return;
  }

  // Build trigger data.
  $trigger_data = [
    'card_id' => $card->id(),
    'card' => [
      'id' => $card->id(),
      'uuid' => $card->uuid(),
      'title' => $card->getTitle(),
      'list_id' => $list_id,
      'labels' => _boxtasks_automation_get_labels($card),
      'due_date' => $card->get('field_card_due_date')->value,
      'completed' => (bool) $card->get('field_card_completed')->value,
    ],
    'list_id' => $list_id,
    'board_id' => $board_id,
  ] + $extra_data;

  // Get the executor service and fire the trigger.
  try {
    /** @var \Drupal\boxtasks_automation\AutomationExecutor $executor */
    $executor = \Drupal::service('boxtasks_automation.executor');
    $results = $executor->fireTrigger((string) $board_id, $trigger_type, $trigger_data);

    // Log results if any rules were executed.
    if (!empty($results)) {
      \Drupal::logger('boxtasks_automation')->info('Fired trigger @type for card @card_id on board @board_id. @count rules executed.', [
        '@type' => $trigger_type,
        '@card_id' => $card->id(),
        '@board_id' => $board_id,
        '@count' => count($results),
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('boxtasks_automation')->error('Error firing automation trigger: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Gets labels from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of label values.
 */
function _boxtasks_automation_get_labels(NodeInterface $card): array {
  $labels = [];
  if ($card->hasField('field_card_labels')) {
    foreach ($card->get('field_card_labels') as $item) {
      $labels[] = $item->value;
    }
  }
  return $labels;
}

/**
 * Gets member IDs from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of member user IDs.
 */
function _boxtasks_automation_get_members(NodeInterface $card): array {
  $members = [];
  if ($card->hasField('field_card_members')) {
    foreach ($card->get('field_card_members') as $item) {
      $members[] = $item->target_id;
    }
  }
  return $members;
}

/**
 * Gets watcher IDs from a card node.
 *
 * @param \Drupal\node\NodeInterface $card
 *   The card node.
 *
 * @return array
 *   Array of watcher user IDs.
 */
function _boxtasks_automation_get_watchers(NodeInterface $card): array {
  $watchers = [];
  if ($card->hasField('field_card_watchers')) {
    foreach ($card->get('field_card_watchers') as $item) {
      $watchers[] = $item->target_id;
    }
  }
  return $watchers;
}

/**
 * Checks for cards with due dates approaching and fires triggers.
 */
function _boxtasks_automation_check_due_dates(): void {
  $now = time();
  $one_day = 86400;

  // Find cards with due dates in the next 24 hours that haven't been notified.
  $query = \Drupal::entityTypeManager()->getStorage('node')->getQuery()
    ->condition('type', 'card')
    ->condition('field_card_due_date', date('Y-m-d\TH:i:s', $now), '>=')
    ->condition('field_card_due_date', date('Y-m-d\TH:i:s', $now + $one_day), '<=')
    ->condition('field_card_completed', FALSE)
    ->accessCheck(FALSE);

  $card_ids = $query->execute();

  if (empty($card_ids)) {
    return;
  }

  $cards = \Drupal::entityTypeManager()->getStorage('node')->loadMultiple($card_ids);

  // Get state service to track which cards have been notified.
  $state = \Drupal::state();
  $notified_cards = $state->get('boxtasks_automation.due_date_notified', []);

  foreach ($cards as $card) {
    // Skip if already notified today.
    $today = date('Y-m-d');
    $state_key = $card->id() . ':' . $today;

    if (in_array($state_key, $notified_cards, TRUE)) {
      continue;
    }

    // Fire the trigger.
    _boxtasks_automation_fire_card_trigger($card, 'due_date_approaching', [
      'due_date' => $card->get('field_card_due_date')->value,
    ]);

    // Mark as notified.
    $notified_cards[] = $state_key;
  }

  // Clean up old notifications (older than today).
  $notified_cards = array_filter($notified_cards, function ($key) use ($today) {
    return str_contains($key, $today);
  });

  $state->set('boxtasks_automation.due_date_notified', $notified_cards);
}
