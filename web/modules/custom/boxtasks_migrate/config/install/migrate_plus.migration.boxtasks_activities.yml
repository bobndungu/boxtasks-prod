id: boxtasks_activities
label: 'BoxTasks Activities'
migration_group: boxtasks
migration_tags:
  - boxtasks
  - activities

source:
  plugin: sql
  key: migrate
  target: default
  query: |
    SELECT
      a.id,
      a.workspace_id,
      a.board_id,
      a.card_id,
      a.user_id,
      a.action,
      a.entity_type,
      a.entity_id,
      a.metadata,
      a.created_at
    FROM activities a
    LEFT JOIN boards b ON a.board_id = b.id
    WHERE (b.deleted_at IS NULL OR a.board_id IS NULL)
    ORDER BY a.created_at ASC
  ids:
    id:
      type: string

process:
  type:
    plugin: default_value
    default_value: activity

  # Store original UUID
  field_original_uuid: id

  # Workspace reference (optional)
  field_activity_workspace:
    plugin: migration_lookup
    migration: boxtasks_workspaces
    source: workspace_id
    no_stub: true

  # Board reference (optional)
  field_activity_board:
    plugin: migration_lookup
    migration: boxtasks_boards
    source: board_id
    no_stub: true

  # Card reference (optional)
  field_activity_card:
    plugin: migration_lookup
    migration: boxtasks_cards
    source: card_id
    no_stub: true

  # Activity type (action)
  field_activity_type: action

  # Entity type
  field_activity_entity_type: entity_type

  # Entity ID (original UUID)
  field_activity_entity_id: entity_id

  # Metadata as JSON string
  field_activity_data:
    plugin: callback
    callable: json_encode
    source: metadata
    unpack_source: false

  # Description (built from action and entity_type)
  field_activity_description:
    plugin: concat
    source:
      - action
      - entity_type
    delimiter: ' '

  # Author (uid)
  uid:
    plugin: migration_lookup
    migration: boxtasks_users
    source: user_id
    no_stub: true

  # Status - published
  status:
    plugin: default_value
    default_value: 1

  # Timestamps
  created:
    plugin: callback
    callable: strtotime
    source: created_at
  changed:
    plugin: callback
    callable: strtotime
    source: created_at

destination:
  plugin: entity:node

migration_dependencies:
  required:
    - boxtasks_users
    - boxtasks_workspaces
    - boxtasks_boards
    - boxtasks_cards
