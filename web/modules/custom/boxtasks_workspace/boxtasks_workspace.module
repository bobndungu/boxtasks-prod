<?php

/**
 * @file
 * BoxTasks Workspace module.
 *
 * Provides workspace management and access control for BoxTasks.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_node_access().
 *
 * Restricts workspace access to only members of the workspace.
 * Restricts board access to members of the parent workspace.
 */
function boxtasks_workspace_node_access(NodeInterface $node, $op, AccountInterface $account) {
  // Only check view operations.
  if ($op !== 'view') {
    return AccessResult::neutral();
  }

  $bundle = $node->bundle();

  // Handle workspace access.
  if ($bundle === 'workspace') {
    return _boxtasks_workspace_check_workspace_access($node, $account);
  }

  // Handle board access.
  if ($bundle === 'board') {
    return _boxtasks_workspace_check_board_access($node, $account);
  }

  return AccessResult::neutral();
}

/**
 * Check if a user has access to view a workspace.
 *
 * @param \Drupal\node\NodeInterface $workspace
 *   The workspace node.
 * @param \Drupal\Core\Session\AccountInterface $account
 *   The user account.
 *
 * @return \Drupal\Core\Access\AccessResultInterface
 *   The access result.
 */
function _boxtasks_workspace_check_workspace_access(NodeInterface $workspace, AccountInterface $account) {
  // Super admin (uid 1) can always access.
  if ((int) $account->id() === 1) {
    return AccessResult::allowed()->addCacheableDependency($account);
  }

  // Users with 'administer nodes' permission can access all workspaces.
  if ($account->hasPermission('administer nodes')) {
    return AccessResult::allowed()->addCacheableDependency($account);
  }

  // Check if user has a member_role for this workspace.
  $has_membership = _boxtasks_workspace_user_has_workspace_membership($workspace->id(), $account->id());

  if ($has_membership) {
    return AccessResult::allowed()
      ->addCacheableDependency($workspace)
      ->addCacheableDependency($account)
      ->addCacheTags(['node_list:member_role']);
  }

  return AccessResult::forbidden('User is not a member of this workspace.')
    ->addCacheableDependency($workspace)
    ->addCacheableDependency($account)
    ->addCacheTags(['node_list:member_role']);
}

/**
 * Check if a user has access to view a board.
 *
 * @param \Drupal\node\NodeInterface $board
 *   The board node.
 * @param \Drupal\Core\Session\AccountInterface $account
 *   The user account.
 *
 * @return \Drupal\Core\Access\AccessResultInterface
 *   The access result.
 */
function _boxtasks_workspace_check_board_access(NodeInterface $board, AccountInterface $account) {
  // Super admin (uid 1) can always access.
  if ((int) $account->id() === 1) {
    return AccessResult::allowed()->addCacheableDependency($account);
  }

  // Users with 'administer nodes' permission can access all boards.
  if ($account->hasPermission('administer nodes')) {
    return AccessResult::allowed()->addCacheableDependency($account);
  }

  // Get the workspace from the board.
  if (!$board->hasField('field_board_workspace') || $board->get('field_board_workspace')->isEmpty()) {
    return AccessResult::forbidden('Board has no workspace.');
  }

  $workspace = $board->get('field_board_workspace')->entity;
  if (!$workspace) {
    return AccessResult::forbidden('Board workspace not found.');
  }

  // Check if user has a member_role for this workspace.
  $has_membership = _boxtasks_workspace_user_has_workspace_membership($workspace->id(), $account->id());

  if (!$has_membership) {
    return AccessResult::forbidden('User is not a member of the board workspace.')
      ->addCacheableDependency($board)
      ->addCacheableDependency($workspace)
      ->addCacheableDependency($account)
      ->addCacheTags(['node_list:member_role']);
  }

  // Check board visibility for private boards.
  $board_visibility = 'workspace';
  if ($board->hasField('field_board_visibility') && !$board->get('field_board_visibility')->isEmpty()) {
    $board_visibility = $board->get('field_board_visibility')->value;
  }

  // For workspace-visible boards, workspace membership is enough.
  if ($board_visibility !== 'private') {
    return AccessResult::allowed()
      ->addCacheableDependency($board)
      ->addCacheableDependency($workspace)
      ->addCacheableDependency($account)
      ->addCacheTags(['node_list:member_role']);
  }

  // For private boards, check if user is a board member or owner.
  $is_board_member = _boxtasks_workspace_is_board_member($board, $account->id());
  $is_owner = (int) $board->getOwnerId() === (int) $account->id();

  if ($is_board_member || $is_owner) {
    return AccessResult::allowed()
      ->addCacheableDependency($board)
      ->addCacheableDependency($account);
  }

  return AccessResult::forbidden('User does not have access to this private board.')
    ->addCacheableDependency($board)
    ->addCacheableDependency($account);
}

/**
 * Check if a user has a member_role for a workspace.
 *
 * @param int $workspace_id
 *   The workspace node ID.
 * @param int $user_id
 *   The user ID.
 *
 * @return bool
 *   TRUE if the user has a member_role for the workspace.
 */
function _boxtasks_workspace_user_has_workspace_membership(int $workspace_id, int $user_id): bool {
  $storage = \Drupal::entityTypeManager()->getStorage('node');

  $member_roles = $storage->getQuery()
    ->condition('type', 'member_role')
    ->condition('field_member_role_workspace', $workspace_id)
    ->condition('field_member_role_user', $user_id)
    ->accessCheck(FALSE)
    ->range(0, 1)
    ->execute();

  return !empty($member_roles);
}

/**
 * Check if a user is a member of a board.
 *
 * @param \Drupal\node\NodeInterface $board
 *   The board node.
 * @param int $user_id
 *   The user ID.
 *
 * @return bool
 *   TRUE if the user is in the board's member list.
 */
function _boxtasks_workspace_is_board_member(NodeInterface $board, int $user_id): bool {
  if (!$board->hasField('field_board_members')) {
    return FALSE;
  }

  foreach ($board->get('field_board_members') as $member_ref) {
    if ($member_ref->target_id && (int) $member_ref->target_id === $user_id) {
      return TRUE;
    }
  }

  return FALSE;
}

/**
 * Implements hook_node_access_records().
 *
 * Define access records for workspace and board nodes.
 * This is used by entity queries with accessCheck(TRUE).
 */
function boxtasks_workspace_node_access_records(NodeInterface $node) {
  $bundle = $node->bundle();

  // Only handle workspace and board nodes.
  if (!in_array($bundle, ['workspace', 'board'])) {
    return [];
  }

  $grants = [];

  // Always grant access to administrators (gid 0).
  $grants[] = [
    'realm' => 'boxtasks_workspace_admin',
    'gid' => 0,
    'grant_view' => 1,
    'grant_update' => 1,
    'grant_delete' => 1,
  ];

  if ($bundle === 'workspace') {
    // For workspaces, create a grant using the workspace node ID.
    // Users with a member_role for this workspace will get this grant.
    $grants[] = [
      'realm' => 'boxtasks_workspace_member',
      'gid' => (int) $node->id(),
      'grant_view' => 1,
      'grant_update' => 0,
      'grant_delete' => 0,
    ];
  }
  elseif ($bundle === 'board') {
    // For boards, get the workspace and create a grant based on workspace ID.
    if ($node->hasField('field_board_workspace') && !$node->get('field_board_workspace')->isEmpty()) {
      $workspace_ref = $node->get('field_board_workspace');
      $workspace_id = $workspace_ref->target_id;

      if ($workspace_id) {
        // Check board visibility.
        $board_visibility = 'workspace';
        if ($node->hasField('field_board_visibility') && !$node->get('field_board_visibility')->isEmpty()) {
          $board_visibility = $node->get('field_board_visibility')->value;
        }

        if ($board_visibility !== 'private') {
          // Workspace-visible board: grant access to workspace members.
          $grants[] = [
            'realm' => 'boxtasks_workspace_member',
            'gid' => (int) $workspace_id,
            'grant_view' => 1,
            'grant_update' => 0,
            'grant_delete' => 0,
          ];
        }
        else {
          // Private board: grant access to board members and owner.
          // Use a board-specific realm.
          $grants[] = [
            'realm' => 'boxtasks_board_member',
            'gid' => (int) $node->id(),
            'grant_view' => 1,
            'grant_update' => 0,
            'grant_delete' => 0,
          ];

          // Also grant to workspace members who need basic access.
          $grants[] = [
            'realm' => 'boxtasks_workspace_member',
            'gid' => (int) $workspace_id,
            'grant_view' => 0,
            'grant_update' => 0,
            'grant_delete' => 0,
          ];
        }
      }
    }
  }

  return $grants;
}

/**
 * Implements hook_node_grants().
 *
 * Grant users access based on their workspace memberships.
 */
function boxtasks_workspace_node_grants(AccountInterface $account, $op) {
  $grants = [];

  // Super admin (uid 1) gets admin grant.
  if ((int) $account->id() === 1) {
    $grants['boxtasks_workspace_admin'] = [0];
    return $grants;
  }

  // Users with 'administer nodes' get admin grant.
  if ($account->hasPermission('administer nodes')) {
    $grants['boxtasks_workspace_admin'] = [0];
    return $grants;
  }

  // Get workspace memberships for this user via member_role.
  $workspace_ids = _boxtasks_workspace_get_user_workspace_ids($account->id());

  if (!empty($workspace_ids)) {
    $grants['boxtasks_workspace_member'] = $workspace_ids;
  }

  // Get board memberships for private boards.
  $board_ids = _boxtasks_workspace_get_user_board_ids($account->id());
  if (!empty($board_ids)) {
    $grants['boxtasks_board_member'] = $board_ids;
  }

  return $grants;
}

/**
 * Get all workspace IDs that a user is a member of.
 *
 * @param int $user_id
 *   The user ID.
 *
 * @return array
 *   Array of workspace node IDs.
 */
function _boxtasks_workspace_get_user_workspace_ids(int $user_id): array {
  $storage = \Drupal::entityTypeManager()->getStorage('node');

  $member_roles = $storage->getQuery()
    ->condition('type', 'member_role')
    ->condition('field_member_role_user', $user_id)
    ->accessCheck(FALSE)
    ->execute();

  if (empty($member_roles)) {
    return [];
  }

  $workspace_ids = [];
  $nodes = $storage->loadMultiple($member_roles);

  foreach ($nodes as $member_role) {
    if ($member_role->hasField('field_member_role_workspace') && !$member_role->get('field_member_role_workspace')->isEmpty()) {
      $workspace_id = $member_role->get('field_member_role_workspace')->target_id;
      if ($workspace_id) {
        $workspace_ids[] = (int) $workspace_id;
      }
    }
  }

  return array_unique($workspace_ids);
}

/**
 * Get all private board IDs that a user is a member of (or owner of).
 *
 * @param int $user_id
 *   The user ID.
 *
 * @return array
 *   Array of board node IDs.
 */
function _boxtasks_workspace_get_user_board_ids(int $user_id): array {
  $storage = \Drupal::entityTypeManager()->getStorage('node');

  // Get boards where user is in field_board_members.
  $member_boards = $storage->getQuery()
    ->condition('type', 'board')
    ->condition('field_board_visibility', 'private')
    ->condition('field_board_members', $user_id)
    ->accessCheck(FALSE)
    ->execute();

  // Get boards where user is the owner.
  $owner_boards = $storage->getQuery()
    ->condition('type', 'board')
    ->condition('field_board_visibility', 'private')
    ->condition('uid', $user_id)
    ->accessCheck(FALSE)
    ->execute();

  $board_ids = array_merge(array_values($member_boards), array_values($owner_boards));

  return array_map('intval', array_unique($board_ids));
}
